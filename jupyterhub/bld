#!/bin/bash
if [ -x ./get_builds ]; then
    ./get_builds > ./jld-lab.env.sh
fi
if [ -f ./jld-lab.env.sh ]; then
    . ./jld-lab.env.sh
fi
if [ -z "${LAB_CONTAINER_NAMES}" ]; then
    export LAB_CONTAINER_NAMES="jld-lab:latest"
    export LAB_CONTAINER_DESCS="Latest"
fi
depyaml="kubernetes/jld-hub-deployment.yml"
sed -e "s|{{LAB_CONTAINER_NAMES}}|\"${LAB_CONTAINER_NAMES}\"|" \
    -e "s|{{LAB_CONTAINER_DESCS}}|\"${LAB_CONTAINER_DESCS}\"|" \
    ${depyaml}.template > ${depyaml}
./bld_1 || exit 2
kubectl delete deployment jld-hub
kubectl create -f ${depyaml}
POD=$(kubectl get pods | grep jld-hub | grep Creating | awk '{print $1}')
while : ;do
    kubectl logs -f $POD
    sleep 10
done
